<!DOCTYPE html>
<html lang="en">
  <head>
        <meta charset="UTF-8">
        <title>Bankema&reg Provenance Module - Version 0.1</title>
        <script language="javascript" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
        <script language="javascript" type="text/javascript" src="collection_abi.js"></script>
        <script language="javascript" type="text/javascript" src="object_abi.js"></script>

        <link rel="stylesheet" type="text/css" href="main.css">
        <link rel="shortcut icon" href="">
    </head>

<body>
    <table id="collectionTable" style="border: 0px; width:100%">
        <tr>
            <td class=nbbl style="width:10%">Collection Name</td> 
            <td class=nb id="collectionList" style="width:12%"></td>
            <td class=nbbl style="width:10%">ObjectValue</td>
            <td class=bp id="objectValueBalance" style="width:12%; background-color: White"></td>
            <td class=nbbl>Last Price</td>
            <td class=bp id="lastPrice" style="background-color: White"></td>
            <td class=nbbl># of Objects</td> 
            <td id="numberObjects" class=b style="background-color: White"></td>
        </tr>
    </table>

    <hr>

    <div id="DisplayPortfolio" style="display:block">

        <hr>

        <div id="objectsDiv" class="scrollit">
            <table id="objectsTable" style="width:176%">
                <tr>
                    <td class="bb" style="width:5%">UID</td> 
                    <td class=bb style="width:15%">Description</td>
                    <td class=bb style="width:10%">Object Value</td>                        
                    <td class=bb style="width:10%">Last Price</td>
                    <td class=bb style="width:10%">Certificate Date</td>                    
                    <td class=bb style="width:15%">Document CID</td>
                    <td class=bb style="width:15%">Document Hash</td>
                    <td class=bb style="width:15%">Photo CID</td>
                    <td class=bb style="width:15%">Photo Hash</td>
                </tr>
            </table>
        </div>

        <hr>

        <table id="addObjectTable" class=adminDisplay style="width:100%">
            <tr>
                <td class=nbl style="width:10%"><button id="addObjectButton" onclick="ddObjectClick()">Add Object</button></td>
                <td class=nbbl style="width:10%">Value</td>
                <td class=nbl style="width:10%"><input id="objectValue" class=b type="date"></td>            
                <td class=nbbl style="width:10%">Object UIC</td>    
                <td class=nbl style="width:20%"><input id="objectUIC" type="text"></td>
                <td class=nbbl style="width:10%">Description</td>  
                <td class=nbl style="width:30%"><input id="description" type="text"></td>
        </tr>
        <tr>
                <td class=nbbl></td>
                <td class=nbbl>lastPrice</td>
                <td class=nbl><input id="lastPrice" type="text"></td>
                <td class=nbbl>Document CID</td>
                <td class=nbl><input id="docCID" type="text"></td>
                <td class=nbbl>Document Hash</td>
                <td class=nbl><input id="docHash" type="text"></td>
        </tr>
        <tr>
                <td class=nbbl></td>
                <td class=nbbl>certificateDate</td>
                <td class=nbl><input id="certificateDate" type="text"></td>
                <td class=nbbl>Photo CID</td>
                <td class=nbl><input id="photoCID" type="text"></td>
                <td class=nbbl>Photo Hash</td>
                <td class=nbl><input id="photoHash" type="text"></td>
            </tr>

        <hr class=adminDisplay>

    <img id="loader" src="waiting-icon-gif-20.jpg">

    <script>

    $("#loader").hide();

    var collectionContract;
    var collectionAddress;
    var myCollection;

    var objectContract;
    var objectAddress;
    var myObject;

    var numberOfObjects = 0;
    var totalObjectValue = 0;
    var totalLastPrice = 0;

    function startApp() {
        collectionAddress = '0xf71dcc329ca962006631c0B48F0a448B156D4470'
        myCollection = new web3js.eth.Contract(collectionABI, collectionAddress);

//        objectAddress = '0xfFA0b7783AfdAb942c3fF1952922F23b05a8eF7a'
//        myObject = new web3js.eth.Contract(objectABI, objectAddress);

        updateCollection();
        }

    function formattedDate(fDate = new Date()){
        let day = String(fDate.getDate());
        let month = String(fDate.getMonth() + 1);
        var year = String(fDate.getFullYear());

        if (month.length < 2) month = '0' + month;
        if (day.length < 2) day = '0' + day;

        return `${year}-${month}-${day}`;
        }

    function cleanDate(fDate = new Date()){
        let day = String(fDate.getDate());
        let month = String(fDate.getMonth() + 1);
        var year = String(fDate.getFullYear());

        if (month.length < 2) month = '0' + month;
        if (day.length < 2) day = '0' + day;

        return `${day}/${month}/${year}`;
        }

    function cleanDateTime(fDate = new Date()){
        let day = String(fDate.getDate());
        let month = String(fDate.getMonth() + 1);
        let year = String(fDate.getFullYear());
        let hour = String(fDate.getHours());
        if (hour.length==1) hour = "0"+hour;
        let minutes = String(fDate.getMinutes());
        if (minutes.length==1) minutes = "0"+minutes;
        let seconds = String(fDate.getSeconds());
        if (seconds.length==1) seconds = "0"+seconds;

        if (month.length < 2) month = '0' + month;
        if (day.length < 2) day = '0' + day;

        return `${day}/${month}/${year} ${hour}:${minutes}:${seconds}`;
        }

    // Update Collection data
    function updateCollection() {

        let collectionCount = myCollection.methods.getNumberObjects().call()
            .then( function(val) {
                numberOfObjects = val;
                console.log("Count:",val);
                
                var oTable = document.getElementById("objectsTable");

                // Define len as the total number of rows in oTable
                var len = oTable.rows.length;

                // Delete all rows apart from the header row 
                if (len > 1)
                    for (var i=len-1;i>0;i--)
                        {
                        console.log("i: " + i);
                        oTable.deleteRow(i);
                        }
                
                var headerCell = oTable.rows[0].cells[0]; 
                $(headerCell).css({"textAlign":"left","paddingLeft":"1em"});
                // Initialize number of Objects to 0
                $(headerCell).html("Object UID (0)");

                // initialize portfolio totals
                totalObjectValue = 0;
                totalLastPrice = 0;

                for (var i=0;i<numberOfObjects;i++) { 

                    console.log("i:", i);

                    let promise1 = myCollection.methods.getObjectInfo(i).call()
                        .then( function(val) {

                        // Define len1 as the total number of rows in oTable
                        len1 = oTable.rows.length;

                        // Assign results from promise to object
                        var object = val;

                        // Find the sorted row in order of LoanID
                        var sortInvoiceID = web3.toAscii(object[1]);
                        var findRow = oTable.rows.length; 
                        for (var j=oTable.rows.length-1;j>0;j--) 
                            {
                            if (oTable.rows[j].cells[0].innerHTML > sortInvoiceID)
                                findRow = j;
                            }

                        var row = oTable.insertRow(findRow);
                        $(row).css({"background-color":"white"});

                        var cell1 = row.insertCell(0);
                        var cell2 = row.insertCell(1);
                        var cell3 = row.insertCell(2);
                        var cell4 = row.insertCell(3);
                        var cell5 = row.insertCell(4);
                        var cell6 = row.insertCell(5);
                        var cell7 = row.insertCell(6);
                        var cell8 = row.insertCell(7);
                        var cell9 = row.insertCell(8);

                        console.log("Len:",len1);

                        // UID
                        $(cell1).html(web3.toAscii(object[1]));
                        $(cell1).css({"textAlign":"left","paddingLeft":"1em"});

                        console.log("UID:",object[1]);
    
                        // Description
                        $(cell2).html(web3.toAscii(object[2]));
                        $(cell2).css({"textAlign":"left","paddingLeft":"1em"});

                        // Obect Value
                        $(cell3).html(object[3]);
                        var objectValue = object[3]/1000000;
                        $(cell3).html(Intl.NumberFormat('en-UK', {maximumFractionDigits: 0}).format(objectValue)).css({"textAlign":"right","paddingRight":"1em"});
                        $(cell3).css({"textAlign":"left","paddingLeft":"1em"});

                        // Last Price
                        $(cell4).html(object[4]);
                        var lastPrice = object[4]/1000000;
                        $(cell4).html(Intl.NumberFormat('en-UK', {maximumFractionDigits: 0}).format(lastPrice)).css({"textAlign":"right","paddingRight":"1em"});
                        $(cell4).css({"textAlign":"left","paddingLeft":"1em"});

                        // Certificate Date
                        var certificateDate = new Date(object[5]*1000);
                        $(cell5).html(cleanDate(certificateDate));

                        // Document CID
                        $(cell6).html(web3.toAscii(object[6]));
                        $(cell6).css({"textAlign":"left","paddingLeft":"1em"});

                        // Document Hash
                        $(cell7).html(web3.toAscii(object[7]));
                        $(cell7).css({"textAlign":"left","paddingLeft":"1em"});

                        // Photo CID
                        $(cell8).html(web3.toAscii(object[8]));
                        $(cell8).css({"textAlign":"left","paddingLeft":"1em"});

                        // Photo Hash
                        $(cell9).html(web3.toAscii(object[9]));
                        $(cell9).css({"textAlign":"left","paddingLeft":"1em"});

                        }); // let promise1 = myCollection.methods.getObjectInfo(i).call()

                    } // for (var i=0;i<numberOfObjects;i++) { 

                }); // let collectionCount = myCollection.methods.getNumberObjects().call()
        
        $("#loader").show();

        console.log(numberOfObjects);

        $("#loader").hide();

    } // function updateCollection() {

    function convertDate(dtString){
        myDate=dtString.split("-");
        var myMonth = myDate[1];
        var myDay = myDate[2];
        newDate = parseInt(new Date(myDate[0]+","+myMonth.toString()+","+myDay.toString()+" 22:00:00").getTime() / 1000).toFixed(0);

        return newDate;
        }

    function convertHTMLtoVal(htmlString){
        var $value = htmlString;
        $value=$value.replace(/[^\/|\/a-zA-Z0-9 ]/g, "");
        $value=$value.split(' ').join('-');

        return $value;
        }

    function csvToHtml(z){  
        for (var j=0; j<z.length;++j) console.log("j; "+j+" : "+z[j]+" "+z.charCodeAt(j))
        // I used the line above to find how the line ends were actually represented: turned out to be  Ascii 13 and 10 hence next line
        var newline=String.fromCharCode(13)+String.fromCharCode(10)

        var R = /,/g
        var T=z.replace(R,"</td><td>");  // trouble with jscript replace is that is not normally global, so need regexp with 'g'
        T=T.replace(RegExp(newline,"g"),"</td></tr><tr><td>");
        T="<table><tr><td>"+T+"</td></tr></table>"
        alert(T);
        }

    window.addEventListener('load', function() {

        window.ethereum.enable();

        // Checking if Web3 has been injected by the browser (Mist/MetaMask)
        if (typeof web3 !== 'undefined') {
            // Use Mist/MetaMask's provider
            web3js = new Web3(web3.currentProvider);
        } else {
            // Handle the case where the user doesn't have Metamask installed
            // Probably show them a message prompting them to install Metamask
            // set the provider you want from Web3.providers - Ropesten
            web3js = new Web3.providers.HttpProvider("http://localhost:3000");
        }

        web3js.eth.defaultAccount = web3js.eth.accounts[0];

        // Now you can start your app & access web3 freely:
        startApp()
      })

    </script>

</body>
</html>